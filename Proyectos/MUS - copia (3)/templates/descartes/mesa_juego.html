<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <title>Musdocemas - Mesa de Juego</title>
    <style>
        /* Estilos Generales */
        body {
            font-family: Arial, sans-serif;
            background-color: #2e2b3f;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 0;
        }
        header {
            width: 100%;
            background-color: #3a3354;
            padding: 10px 0;
            text-align: center;
        }
        header h1 {
            margin: 0;
        }

        /* Contenedor Principal */
        .contenedor {
            width: 90%;
            max-width: 1400px;
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        /* Mesa de Juego */
        .mesa-de-juego {
            width: 70%;
            background-color: #4e495e;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5);
            display: grid;
            grid-template-rows: 1fr auto 1fr;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            justify-items: center;
            position: relative;
        }

        /* Tablero de Puntuación */

.tablero {
  position: absolute;
  top: 20px;
  left: 20px;
  background-color: #3a3354;
  color: #ffffff;
  padding: 15px;
  border-radius: 8px;
  text-align: center;
  width: 250px;
  box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.5);
}

.tablero h2 {
  margin: 0 0 10px 0;
  font-size: 1.4em;
}

.puntuacion-tabla {
  width: 100%;
  border-collapse: collapse;
}

.puntuacion-tabla th,
.puntuacion-tabla td {
  padding: 8px;
  border: 1px solid #ffffff;
  text-align: center;
}

.puntuacion-tabla th {
  background-color: #4a3f67;
  font-weight: bold;
}

.puntuacion-tabla tbody tr:nth-child(even) {
  background-color: #4f4373;
}




        /* Jugadores */
        .jugador {
            display: flex;
            align-items: center;
            flex-direction: column;
			position: relative;
			text-align: center;
			transition: transform 0.3s ease, font-size 0.3s ease;

        }
		
        .jugador img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-bottom: 5px;
            border: 2px solid #fff;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.3);
			transition: transform 0.3s ease; 
		}

		.jugador .alias {
			margin-top: 5px;
			font-size: 15px;
			font-weight: bold;
			position: relative; /* Necesario para posicionar el indicador relativo al alias */
			transition: font-size 0.3s ease, color 0.3s ease;
			}

		.jugador.mano img {
			transform: scale(1.2); /* Aumenta el tamaño del avatar */
			border-color: gold; /* Cambia el borde a un color llamativo */
			animation: blink 1s ease-in-out 3; /* Parpadeo */
		}

		/* Definición de la animación de parpadeo */
		@keyframes blink {
			0%, 100% {
				border-color: gold;
			}
			50% {
				border-color: transparent;
			}
		}
		.jugador.mano .alias {
			color: gold; /* Cambia el color del alias */
			font-size: 18px; /* Aumenta el tamaño del alias */
		}			
				/* Posición de los jugadores */
				.jugador-1 { grid-row: 3; grid-column: 2; }
				.jugador-3 { grid-row: 1; grid-column: 2; }
				.jugador-4 { grid-row: 2; grid-column: 1; }
				.jugador-2 { grid-row: 2; grid-column: 3; }

				/* Cartas */

.cartas {
  display: flex;
  justify-content: center;
  gap: 10px;
  padding: 10px;
  /*border: 2px dashed #3a3354;*/
  border-radius: 8px;
  background-color: #E0E0E0; /* #f4f4f4;*/
}
.carta {
    width: 52px; /* Mantén el tamaño original */
    height: 85px; /* Mantén el tamaño original */
  background-size: cover;
  background-position: center center;
  cursor: pointer;
  transition: border 0.3s ease, transform 0.3s ease;
  border: 2px solid transparent; /* Sin borde por defecto */
} 

.carta.seleccionada {
  transform: scale(1.4) rotate(-5deg);
  box-shadow: 0 0 15px rgba(255, 255, 0, 0.8);
}
 /*background-color: #6c5b7b;
  color: #fff;
    overflow: hidden;
    display: flex;
    justify-content: center;
      font-size: 16px;
      font-weight: bold;
    align-items: center;
    position: relative;
    border-radius: 5px; /* Bordes redondeados */
    box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.3);
  cursor: pointer;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}*/

.carta:active {
  cursor: grabbing;
}

.carta.over {
  border: 2px solid #f67280;
}

.carta img {
    width: 90%; /* Imagen más pequeña para simular el margen */
    height: 90%; /* Imagen más pequeña para simular el margen */
    object-fit: cover; /* Ajusta la imagen sin deformarla */
    border-radius: 5px; /* Un poco menos que el contenedor para mantener estilo */
}

		.carta-oculta {
			background-image: url('../static/img/cartas/reversoazul3.png');
			background-size: contain;
			background-position: center;
		}

        /* Panel de Botones para Jugador Principal */
        .botones {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            position: absolute;
            bottom: 55px;
            right: 15%;
        }
        .boton {
            padding: 8px 15px;
            background-color: #8b6fae;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            text-align: center;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s ease;
        }
        .boton:hover {
            background-color: #a785d1;
        }

        /* Chat */
        .chat {
            width: 25%;
            background-color: #333;
            padding: 10px;
            border-radius: 8px;
            max-height: 500px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.5);
        }
        .chat h3 {
            color: #a785d1;
            margin-bottom: 10px;
        }
        .chat-mensaje {
            margin: 5px 0;
        }
        .chat-input {
            display: flex;
            margin-top: auto;
        }
        .chat-input input {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
        }
        .chat-input button {
            padding: 10px 20px;
            margin-left: 5px;
            border: none;
            background-color: #645a7a;
            color: #fff;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s ease;
        }
        .chat-input button:hover {
            background-color: #7d6b92;
        }
		.boton-repartir-container {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			z-index: 2; /* Para asegurarte de que está por encima del fondo */
		}

		#btn-repartir {
			padding: 15px 30px;
			font-size: 18px;
			font-weight: bold;
			color: #fff;
			background: linear-gradient(45deg, #4CAF50, #81C784); /* Gradiente atractivo */
			border: none;
			border-radius: 8px;
			cursor: pointer;
			box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.3);
			transition: transform 0.2s, background-color 0.3s;
		}

		#btn-repartir:hover {
			transform: scale(1.1);
			background: linear-gradient(45deg, #388E3C, #66BB6A); /* Cambia a un gradiente más oscuro */
		}

		#btn-repartir:active {
			transform: scale(0.95);
			box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.2);
		}
		.oculto {
			display: none;
		}
header {
    background-color: #4c4c4c; /* Fondo del header */
    padding: 15px; /* Espaciado interno */
    text-align: center; /* Centrar el texto */
    color: white; /* Color del texto */
}

header h1 {
    font-size: 24px; /* Tamaño del título general */
    margin: 0; /* Elimina márgenes */
}

header h1 .mesa-nombre {
    font-weight: bold; /* Negrita para el nombre de la mesa */
    font-size: 26px; /* Tamaño ligeramente mayor */
    color: #f0c674; /* Color diferenciado para el nombre de la mesa */
}

header h1 .usuario {
    font-weight: normal; /* Peso normal para el usuario */
    font-size: 20px; /* Tamaño un poco más pequeño */
    color: #b5d6a8; /* Color diferenciado para el usuario */
}
.bocadillo {
    position: absolute;
    top: -40px; /* Por encima del jugador */
    left: 50%;
    transform: translateX(-50%);
    background-color: #f0c674; /* Fondo dorado para destacar */
    color: black; /* Texto en negro */
    padding: 5px 10px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: bold;
    visibility: hidden; /* Oculto por defecto */
    opacity: 0; /* Transparente inicialmente */
    transition: opacity 0.3s ease, visibility 0.3s ease;
}

/* Flecha del bocadillo */
.bocadillo::after {
    content: "";
    position: absolute;
    bottom: -5px;
    left: 50%;
    transform: translateX(-50%);
    border-width: 5px;
    border-style: solid;
    border-color: #f0c674 transparent transparent transparent;
}
/* Estilo para el mazo */
.mazo {
    position: absolute;
    width: 50px;
    height: 30px;
    background-image: url('../static/img/cartas/reversoazul3mazo.png'); /* Cambia la ruta por la de tu imagen */
    background-size: cover;
    position: absolute;
    /*transform: rotate(30deg); Aplica el ángulo necesario */
}

.mazo img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 5px;
    box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.3);
}

.botones-juego button {
  padding: 10px 20px;
  font-size: 16px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  background-color: #4CAF50;
  color: white;
  transition: opacity 0.3s;
}

.botones-juego button:disabled {
  background-color: #9E9E9E;
  cursor: not-allowed;
}
.botones-juego {
  display: flex;
  justify-content: center; /* Centrar horizontalmente */
  align-items: center;    /* Centrar verticalmente */
  position: absolute;     /* Para posicionarlos en el centro absoluto de la mesa */
  top: 50%;               /* Centrar verticalmente */
  left: 50%;              /* Centrar horizontalmente */
  transform: translate(-50%, -50%); /* Ajustar el desplazamiento del centro */
  gap: 20px;              /* Espaciado entre botones */
  z-index: 10; /* Asegura que los botones estén por encima de otros elementos */
}

#descartar {
  padding: 10px 20px;
  font-size: 16px;
  background-color: lightgray;
  color: black;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  transition: background-color 0.3s ease;
  pointer-events: none; /* Deshabilita clics por defecto */
  opacity: 0.5; /* Reduce la opacidad para indicar que está inactivo */
}

#descartar:hover {
  background-color: yellowgreen;
}

#descartar.oculto {
  display: none; /* Clase para ocultar el botón */
}
#descartar.activo {
    pointer-events: auto; /* Habilita clics */
    opacity: 1; /* Restaura la opacidad */
}

.mesa-botones {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px; /* Mayor espacio entre los botones principales */
  margin-top: 20px; /* Espaciado superior */
}

.fila {
  display: flex;
  justify-content: space-around; /* Espaciado igual entre botones */
  width: 100%; /* Usar todo el ancho disponible */
  max-width: 300px; /* Limita el ancho de la fila para que no sea demasiado extensa */
  gap: 20px; /* Espacio adicional entre botones si es necesario */
  margin: 0 auto; /* Centra la fila horizontalmente */
}

.envido-control {
  display: flex;
  gap: 10px; /* Espaciado entre los controles de envido */
  justify-content: center;
  align-items: center; /* Centra verticalmente los botones con el número */
}

button {
  background-color: #1E90FF; /*#F4A261;*/ /* Naranja suave y cálido */
  color: white;
  border: none;
  border-radius: 8px; /* Bordes redondeados para un aspecto amigable */
  padding: 12px 20px; /* Más espacio para hacerlos cómodos */
  font-size: 16px; /* Tamaño de texto legible */
  cursor: pointer;
  transition: background-color 0.4s ease, box-shadow 0.3s ease; /* Transiciones suaves */
}

button:hover {
  background-color: #E76F51; /* Naranja rojizo suave al pasar el ratón */
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15); /* Sombra ligera */
}

button:active {
  background-color: #D66A50; /* Color más oscuro al hacer clic */
  box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2); /* Efecto de presionado */
}


#valor-envido {
  font-size: 20px;
  font-weight: bold;
  margin: 0 10px; /* Espaciado entre el número y los botones */
}
.fade-in {
  animation: fadeIn 0.5s ease-in-out;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
	.turno-notificacion {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      font-size: 14px;
      opacity: 1;
      visibility: visible;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }

    .turno-notificacion.oculto {
      opacity: 0;
      visibility: hidden;
    }

	.turno-label {
	  font-size: 18px;
	  font-weight: bold;
	  text-align: center;
	  margin-bottom: 10px; /* Espaciado estándar */
	  position: absolute; /* Posición absoluta para colocarlo sobre los botones */
	  top: -30px; /* Ajusta según el espacio que necesites */
	  left: 50%; /* Centra horizontalmente */
	  transform: translateX(-50%); /* Compensa el centrado horizontal */
	  z-index: 10; /* Asegura que esté por encima de otros elementos */
	}
	.turno-label.oculto {
		display: none; /* Oculta el elemento */
	}	
   .botoncm:disabled {
		background-color: #ccc;
		cursor: not-allowed;
	}
	.botoncm {
		padding: 10px 20px;
		font-size: 16px;
		cursor: pointer;
		border: 1px solid #000;
		border-radius: 5px;
		background-color: #f0f0f0;
	}
	.botoncm:hover:not(:disabled) {
		background-color: #d0d0d0;
	}
	.bloqueado {
	  pointer-events: none; /* Bloquea interacción */
	  opacity: 0.5; /* Indica visualmente que está deshabilitado */
	  cursor: not-allowed; /* Cambia el cursor al pasar sobre ellos */
	}
	.texto-lance {
	  font-size: 40px;
	  font-weight: bold;
	  color: #ffffff; /* Blanco */
	  text-align: center;
	  margin-bottom: 10px; /* Espacio entre el texto y los botones */
	  animation: fadeIn 0.5s ease-in-out; /* Animación al cambiar */
}
	
    </style>
</head>
<body>

    <!-- Encabezado -->
<header> 
    <h1>
        Musdocemas - Mesa de Juego 
        <span class="usuario">{{ usuario }}</span>
       <!-- <span class="mesa-nombre">{{ mesa.nombre }}</span>-->
    </h1>
</header>

    <!-- Contenedor Principal -->
    <div class="contenedor">
        <!-- Mesa de Juego -->
        <div class="mesa-de-juego">
            <!-- Tablero de Puntuación -->
        <p></p>
			<div class="tablero">
			  <table class="puntuacion-tabla">
				<thead>
				  <tr>
					<th>Jugadores</th>
					<th>Juegos</th>
					<th>Puntos</th>
				  </tr>
				</thead>
				<tbody>
				  <tr>
					<td id="pareja1">Pareja 1</td>
					<td id="juegos-pareja1">0</td>
					<td id="puntos-pareja1">0</td>
				  </tr>
				  <tr>
					<td id="pareja2">Pareja 2</td>
					<td id="juegos-pareja2">0</td>
					<td id="puntos-pareja2">0</td>
				  </tr>
				</tbody>
			  </table>

			</div>		<!-- Jugadores -->	
			<div class="turno-notificacion oculto" id="turnoNotificacion">Hola</div>	
			<div class="jugador jugador-1">
				<img src="" alt="Avatar Jugador 1">
				<span class="alias"></span> 
				<div class="bocadillo"></div>
				<div class="cartas">
				  <div class="carta" draggable="true" id="carta1" data-id="1" alt="Carta 1"></div>
				  <div class="carta" draggable="true" id="carta2" data-id="2" alt="Carta 2"></div>
				  <div class="carta" draggable="true" id="carta3" data-id="3" alt="Carta 3"></div>
				  <div class="carta" draggable="true" id="carta4" data-id="4" alt="Carta 4"></div>
				</div>	
			</div>
			<div class="jugador jugador-2">
				<img src="" alt="Avatar Jugador 2">
				<span class="alias"></span>
				<div class="bocadillo"></div>
				<div class="cartas">
					<div class="carta carta-oculta"></div>
					<div class="carta carta-oculta"></div>
					<div class="carta carta-oculta"></div>
					<div class="carta carta-oculta"></div>
				</div>
			</div>
			<div class="boton-repartir-container">
				<button id="btn-repartir" onclick="repartirCartas()">Repartir</button>
			</div>	
			<div class="mesa-juego">
			  <!-- Otros elementos de la mesa 
			  <div id="turnoJugador" class="turno-label"></div>-->
			  <div class="botones-juego" id="botones-juego" style="display: none;">
				<button id="btn-corto" class="botoncm" onclick="accionCorto()">Corto</button>
				<button id="btn-mus" class="botoncm" onclick="accionMus()">Mus</button>
			  </div>
			</div>

			<div class="mesa-botones" style="display: none;">
			  <div id="texto-lance" class="texto-lance"></div>
			  <div class="fila">
			    <button id="ordago" class="botines">¡Órdago!</button>
				<button id="ver" class="botines">Veo</button>
				<button id="paso" class="botines">Paso</button>
			  </div>
			  <div class="envido-control">
				<button id="decrementar-envido" class="botines">-</button>
				<span id="valor-envido">2</span>
				<button id="incrementar-envido" class="botines">+</button>
				<button id="envidar" class="botines">Envido</button>
			  </div>
			</div>
			<button id="descartar" style="display: none;">Descartar</button>
			<!--<button id="descartar" style="display: none;" onclick="descartarCartas()">Descartar</button>-->
			<div id="mazo" class="mazo">
				<img src="../static/img/cartas/reversoazul3mazo.png" alt="Mazo de cartas">
			</div>
			<div class="jugador jugador-3">
				<img src="" alt="Avatar Jugador 3">
				<span class="alias"></span>
				<div class="bocadillo"></div>
				<div class="cartas">
					<div class="carta carta-oculta"></div>
					<div class="carta carta-oculta"></div>
					<div class="carta carta-oculta"></div>
					<div class="carta carta-oculta"></div>
				</div>
			</div>
			<div class="jugador jugador-4">
				<img src="" alt="Avatar Jugador 4">
				<span class="alias"></span>
				<div class="bocadillo"></div>
				<div class="cartas">
					<div class="carta carta-oculta"></div>
					<div class="carta carta-oculta"></div>
					<div class="carta carta-oculta"></div>
					<div class="carta carta-oculta"></div>
				</div>
			</div>
            <!-- Panel de Botones -->
        <!--    <div class="botones">
                <button class="boton">Mus</button>
                <button class="boton">Corto</button>
                <button class="boton">Envido</button>
                <button class="boton">Paso</button>
            </div> -->
        </div>
        <!-- Chat de Juego -->
        <div class="chat">
            <h3>Chat de la {{ mesa.nombre }}</h3>
			<div id="chat-box" class="chat-box">
				<!-- Aquí se mostrarán los mensajes del chat -->
			</div>
            <div class="chat-input">
                <input type="text" placeholder="Escribe un mensaje..." id="chat-message_mesa">
                <button onclick="sendMessage()">Enviar</button>
            </div>
        </div>	

 </div>
	<script>
		const socket = io();
		
		const mesa = {{ mesa|tojson }};
		//const jugador = "{{ usuario }}";	
		//alert("Usuario al entrar en mesa juego: " + jugador);
		// Define las posiciones relativas (abajo, izquierda, arriba, derecha)
		const posiciones = ["jugador-1", "jugador-2", "jugador-3", "jugador-4"];
		// Reorganizar las posiciones según el usuario
		const reorganizedJugadores = [];
		const reorganizedAvatares = [];
	    const cartasOriginales = [];
		// Funcion principal que carga la mesa con los datos de jugadores
		
		document.addEventListener("DOMContentLoaded", () => {
			const mesa = {{ mesa|tojson }}; // Datos de la mesa desde el servidor
			actualizarMesa(mesa);
		});
		
		//Refrescar la mesa:
		function actualizarMesa(mesa) {
			const username = "{{ usuario }}"; // Usuario actual desde Flask
			const jugadores = mesa.jugadores; // Lista de jugadores desde Python
			const avatares = mesa.avatares; // Lista de avatares desde Python
			const mano = mesa.mano; // Índice del jugador que es mano
			const manoJugador = jugadores[mano]; // Nombre del jugador que es mano
			const jugadorTurno = manoJugador;
			console.log("ACTUALIZAR MESA:", mesa, "JugadorTurno en ActualizarMesa: ", jugadorTurno);
			let reparte = 0;
			if (mano === 0) {
				reparte = 3;
			} else {
				reparte = mano - 1;
			}
			const reparteJugador = jugadores[reparte];
			actualizarMazo(reparte);
			// Encuentra la posición del usuario en el array
			const userIndex = jugadores.findIndex(jugador => jugador === username);

			if (userIndex === -1) {
				console.error("El usuario no está en la mesa.");
				return;
			}

			// Define las posiciones relativas (abajo, izquierda, arriba, derecha)
			//const posiciones = ["jugador-1", "jugador-2", "jugador-3", "jugador-4"];

			for (let i = 0; i < jugadores.length; i++) {
				const newIndex = (i - userIndex + jugadores.length) % jugadores.length;
				reorganizedJugadores[newIndex] = jugadores[i];
				reorganizedAvatares[newIndex] = avatares[i];
			}

			// Actualiza el DOM con los datos reorganizados
			reorganizedJugadores.forEach((jugador, index) => {
				//alert("Pulsa MUS y entra por reorganizedJugadores.forEach");
				const position = posiciones[index];
				const jugadorElement = document.querySelector(`.${position}`);
				console.log("jugadorelement reorganizedJugadores: ", jugadorElement, " position: ", position);

				if (jugadorElement) {
					const avatarElement = jugadorElement.querySelector("img");
					const aliasElement = jugadorElement.querySelector(".alias");

					// Actualiza avatar y alias
					avatarElement.src = reorganizedAvatares[index] || "../static/img/avatares/avatar.png";
					aliasElement.textContent = jugador || "Vacío";

					// Resalta el jugador que es mano
					if (jugador === manoJugador) {
						jugadorElement.classList.add("mano");
						console.log("jugadorelement bocadillo: ", jugadorElement, " position: ", position);
						// Mostrar mensaje "Soy mano"
						//mostrarBocadillo(jugadorElement, "Soy mano");
						let index2 = 0;
						if (index === 0) { index2 = 3; } else { index2 = index - 1; }
						const position2 = posiciones[index2];
						const jugadorElement2 = document.querySelector(`.${position2}`);
						//mostrarBocadillo(jugadorElement2, "Reparto");
						mostrarBocadillo2(index2, "Reparto");
						mostrarBocadillo2(index, "Soy mano");
						// Enviar mensaje al chat informando
						//const mensaje = "El mano es " + manoJugador + " y reparte " + reparteJugador;
						//socket.emit('mensaje_chat_mesa', { mesa_id: mesaId, username: 'Docemas', message: mensaje });
						// Reinicia la animación del avatar
						avatarElement.style.animation = "none";
						setTimeout(() => {
							avatarElement.style.animation = ""; // Reactiva la animación
						}, 10);
					} else {
						jugadorElement.classList.remove("mano");
					}
				}
			});
		inicializarPuntuacion(mesa);
		}

		function mostrarBocadillo(jugadorElement, mensaje) {
			//alert("Entra en mostrar bocadillo. ");
			const bocadillo = jugadorElement.querySelector(".bocadillo");
			bocadillo.textContent = mensaje; // Escribe el mensaje en el bocadillo
			bocadillo.style.visibility = "visible";
			bocadillo.style.opacity = "1";

			// Oculta el bocadillo después de 3 segundos
			setTimeout(() => {
				bocadillo.style.opacity = "0";
				bocadillo.style.visibility = "hidden";
			}, 4000);
		}	

		function mostrarBocadillo2(indice, mensaje) {
			//alert("Entra en mostrar bocadillo.2 ");
			const position = posiciones[indice];
			const jugadorElement = document.querySelector(`.${position}`);
			const bocadillo = jugadorElement.querySelector(".bocadillo");
			bocadillo.textContent = mensaje; // Escribe el mensaje en el bocadillo
			bocadillo.style.visibility = "visible";
			bocadillo.style.opacity = "1";

			// Oculta el bocadillo después de 3 segundos
			setTimeout(() => {
				bocadillo.style.opacity = "0";
				bocadillo.style.visibility = "hidden";
			}, 4000);
		}			

		//Función para refrescar la puntuacion:
		function actualizarPuntuacion(mesa) {
			// Ejemplo: simulación de una actualización en el transcurso de la partida
			setTimeout(() => {
			  mesa.puntos[0] = 5; // Puntos para la pareja 1
			  mesa.juegos[0] = 1; // Juegos ganados para la pareja 1
			  actualizarPuntuacion("pareja1", mesa.juegos[0], mesa.puntos[0]);
			}, 2000);

			setTimeout(() => {
			  mesa.puntos[1] = 7; // Puntos para la pareja 2
			  actualizarPuntuacion("pareja2", mesa.juegos[1], mesa.puntos[1]);
			}, 4000);
		}

		socket.on('mesa_actualizada', function(mesa) {
			console.log('Mesa actualizada:', mesa);
			console.log("Recibidos nuevos datos de la mesa:", mesa);
			actualizarMesa(mesa);
			alert("Parada para ver mesa: ");
		});

		// Actualizar la vista de la mesa con los nuevos datos
		socket.on('jugadores_actualizados', function(mesa) {
			const jugadores = document.querySelectorAll('.jugador');
			mesa.jugadores.forEach((jugador, index) => {
				const jugadorElement = jugadores[index];
				if (jugador) {
					jugadorElement.querySelector('img').src = jugador.avatar;
					jugadorElement.querySelector('span').textContent = jugador.username;
				} else {
					jugadorElement.querySelector('img').src = "../static/img/avatar.png";
					jugadorElement.querySelector('span').textContent = "Vacante";
				}
			});
		});


		// Obtener el ID de la mesa desde la plantilla
		const mesaId = "{{ mesa.nombre }}";
		const username = "{{ usuario }}"; // Reemplaza con el nombre real del usuario
			//alert("Mesa_nombre: " + mesaId);
		// Unirse a la sala de la mesa
		//socket.emit('join_mesa', { mesa_id: mesaId, username: username });

		window.onload = function() {
			const username = "{{ usuario }}";
			const mesaId = "{{ mesa.nombre }}";
			//alert("Mesa.nombre: " + mesaId);
			// Redimensionar la ventana a un tamaño específico
			//alert("Va a redimensionar la pantalla");
			// Solo funciona en ventanas abiertas con window.open
			if (window.outerWidth !== 1024 || window.outerHeight !== 768) {
				window.resizeTo(1524, 808);
			}
			// Opcionalmente, mover la ventana al centro
			const x = (window.screen.availWidth - 1524) / 2;
			const y = (window.screen.availHeight - 808) / 2;
			window.moveTo(x, y);
			//socket.emit('join_mesa', { username: username, mesa_id: mesaId });
		};
		
		// Escuchar el evento 'mensaje_mesa' para mostrar los mensajes en el chat
		socket.on('mensaje_mesa', function(data) {
			console.log("Entra en mensaje_mesa con data:", data);
			//alert("Entra en mensaje mesa");
			const chatBox = document.getElementById('chat-box');
			const messageElement = document.createElement('div');
			messageElement.classList.add('chat-mensaje');
			messageElement.innerHTML = `<strong>${data.username}:</strong> ${data.msg}`;
			chatBox.appendChild(messageElement);
			chatBox.scrollTop = chatBox.scrollHeight; // Desplaza el chat hacia abajo
		});

		// Detectar la tecla Enter en el campo de texto del chat
		document.getElementById('chat-message_mesa').addEventListener('keypress', function (event) {
			if (event.key === 'Enter') { // Verifica si se pulsó la tecla Enter
				event.preventDefault(); // Previene el comportamiento por defecto (nueva línea)
				sendMessage(); // Llama a la función para enviar el mensaje
			}
		});
		// Función para enviar mensajes al servidor
		window.sendMessage = function() {
			const username = "{{ usuario }}";
			const mesaId = "{{ mesa.nombre }}";
			const message = document.getElementById('chat-message_mesa').value.trim();
			if (message) {
				console.log("Enviando mensaje:", message);
			    //alert("Va a hacer emit del mensaje: " + message);
				socket.emit('mensaje_chat_mesa', { username: username, message: message, mesa_id: mesaId });
				document.getElementById('chat-message_mesa').value = ''; // Limpiar el campo de entrada
			}
		};

        /*socket.on('chat_message_mesa', function(data) {
            const chatBox = document.getElementById('chat-box');
            const messageElement = document.createElement('p');
            messageElement.textContent = `${data.username}: ${data.message}`;
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
		});	*/	
		//==========================================================================================
		// Funcion para el reparto de cartas
		//==========================================================================================
		function repartirCartas() {
			const mesaId = "{{ mesa.nombre }}"; // Obtenemos el ID de la mesa desde la plantilla
			socket.emit('repartir_cartas', { mesa_id: mesaId });

			// Actualizar el repartidor y mover el mazo
			//actualizarMazo(reparte);		    

			// Enviar mensaje al chat informando
			const mensaje = "Repartiendo cartas...";
			socket.emit('mensaje_chat_mesa', { mesa_id: mesaId, username: 'Docemas', message: mensaje });
			
			// Ocultar el botón una vez que se pulsa
			const btnRepartir = document.getElementById("btn-repartir");
			btnRepartir.classList.add("oculto");
			//const jugadores = mesa.jugadores;
			//const mano = mesa.mano;
			//const jugadorMano = jugadores[mano];
			//console.log("En repartir cartas el mano es : ", jugadorMano);
			// Actualizar los botones de Corto y Mus para que solo el jugador "mano" los tenga activos
			//mostrarBotones(jugadorMano);
			//const botonesJuego = document.getElementById('botones-juego');
			//botonesJuego.style.display = 'flex'; // Mostrar los botones
		}

		//*************************************************************************
		//   AQUI ES DONDE SE REPARTEN LAS CARTAS ENTRE LOS 4 JUGADORES
		//*************************************************************************
		// Escuchar el evento 'cartas_repartidas' para mostrar las cartas en la interfaz
		socket.on('cartas_repartidas', function(data) {
			if (data.mesa_id !== "{{ mesa.nombre }}") {
				alert("No coinciden los datos de la mesa: " + data.mesa_id);
				return; // Verificamos que es la mesa actual
			}			
			const manos = data.manos;
			const mano = data.mano;
			//alert("Entra por cartas_repartidas y Asignar las cartas a cada jugador");
			console.log("Manos: ", manos);

			// Ocultar el botón repartir y habilita corto y mus una vez que se entra desde el servidor
			const btnRepartir = document.getElementById("btn-repartir");
			btnRepartir.classList.add("oculto");

			const jugadores = mesa.jugadores;
			const jugadorMano = jugadores[mano];
			console.log("En repartir cartas el mano es : ", jugadorMano);
			mostrarBotones(jugadorMano);
			//const botonesJuego = document.getElementById('botones-juego');
			//botonesJuego.style.display = 'flex'; // Mostrar los botones
			//alert("Actualiza los botones");

			Object.keys(manos).forEach((jugador) => {
				const cartas = manos[jugador];

				// Encuentra el div correspondiente al jugador actual
				const jugadorDiv = Array.from(document.querySelectorAll('.jugador')).find(div => {
					const alias = div.querySelector('.alias').textContent;
					return alias === jugador;
				});

				if (jugadorDiv) {
					// Limpiar las cartas actuales
					const cartasDiv = jugadorDiv.querySelector('.cartas');
					cartasDiv.innerHTML = '';

					// Asignar las cartas
					cartas.forEach(carta => {
						const cartaElement = document.createElement('div');
						cartaElement.classList.add('carta');

						// Crear la ruta de la imagen
						const rutaImagen = `/static/img/cartas/${carta}.png`;
						cartaElement.style.backgroundImage = `url(${rutaImagen})`;
						cartaElement.style.backgroundSize = 'cover';
						cartaElement.style.backgroundPosition = 'center';

						cartasDiv.appendChild(cartaElement);
					});
				}
			});
		});

	  // Función para mostrar los botones de MUS y Corto después de repartir
	    function mostrarBotones(jugadorActual) {
			const username = "{{ usuario }}";
			const botonesJuego = document.getElementById('botones-juego');
			//const turnoLabel = document.getElementById("turnoJugador");
			const btnCorto = document.getElementById('btn-corto');
			const btnMus = document.getElementById('btn-mus');
			console.log("Va a MOSTRAR los botones de Corto y Mus.");
			//turnoLabel.classList.remove("oculto"); 
			botonesJuego.style.display = 'flex'; // Mostrar los botones de MUS y Corto
			//turnoLabel.textContent = `Turno ${jugadorActual}`; // Mostrar etiqueta con el jugador en turno
			mostrarTurno(jugadorActual);
			// Activar los botones de Mus y Corto solo para el usuario del turno
			btnCorto.disabled = true;
			btnMus.disabled = true;
			if (username === jugadorActual) {
                btnCorto.disabled = false;
                btnMus.disabled = false;
            }
	    }

		// Mostrar notificación de turno con intervalo de tres segundos
		function mostrarTurno(jugador) {
			const turnoNotificacion = document.getElementById("turnoNotificacion");
			turnoNotificacion.textContent = `Es el turno de ${jugador}`;
			turnoNotificacion.classList.remove("oculto");

		  // Ocultar la notificación después de 3 segundos
		  setTimeout(() => {
			turnoNotificacion.classList.add("oculto");
		  }, 3000);
		}
		
		// Escuchar errores del servidor
		socket.on('error', function(data) {
			alert(data.message);
		});

		// Función para generar las parejas y actualizar la tabla
		function inicializarPuntuacion(mesa) {
			const jugadores = mesa.jugadores;

		  // Crear las parejas
		  const pareja1 = `${truncarNombre(jugadores[0])} - ${truncarNombre(jugadores[2])}`;
		  const pareja2 = `${truncarNombre(jugadores[1])} - ${truncarNombre(jugadores[3])}`;

		  // alert("Pareja 1:" + pareja1);
		  // Actualizar el HTML
			document.getElementById("pareja1").textContent = pareja1;
			document.getElementById("pareja2").textContent = pareja2;

		  // Inicializar los puntos y juegos
			actualizarPuntuacion("pareja1", mesa.juegos[0], mesa.puntos[0]);
			actualizarPuntuacion("pareja2", mesa.juegos[1], mesa.puntos[1]);
		}
		
		// Función para truncar los nombres a los 4 primeros caracteres
		function truncarNombre(nombre) {
		  return nombre.substring(0, 4); // Toma los primeros 4 caracteres
		}

		// Función para actualizar puntos y juegos
		function actualizarPuntuacion(parejaId, juegos, puntos) {
		  document.getElementById(`juegos-${parejaId}`).textContent = juegos;
		  document.getElementById(`puntos-${parejaId}`).textContent = puntos;
		}

		//===========================================================
		// LOGICA PARA DETERMINAR SI TODOS SE DAN MUS O ALGUIEN CORTA
		//===========================================================

		document.addEventListener('DOMContentLoaded', () => {
		  // Lista de jugadores
		  //const jugadores = ['Gordiano1', 'Gordiano10', 'Gordiano11', 'Gordiano12'];
		  const jugadores = mesa.jugadores;
		  let indiceMano = mesa.mano; // Índice del jugador que es "mano"
		  // Referencias a elementos
		  const btnCorto = document.getElementById('btn-corto');
		  const btnMus = document.getElementById('btn-mus');
		  const botonesJuego = document.getElementById('botones-juego');


		  // Acción al pulsar "Corto"
		  window.accionCorto = function () {
			const mesaId = "{{ mesa.nombre }}";
			//alert("En Corto mesaId: " + mesaId);
			console.log(`${jugadores[indiceMano]} ha pulsado Corto y pasa a ser mano. El juego comienza.`);
			const mensaje = `${jugadores[indiceMano]} ha pulsado Corto y pasa a ser mano. El juego comienza.`;
			socket.emit('mensaje_chat_mesa', { mesa_id: mesaId, username: 'Docemas', message: mensaje });
			//*******************************		
			//alert("Se corta el MUS");
			jugadorTurno = jugadores[indiceMano];
			socket.emit('tratar_corto', { mesa_id: mesaId, jugadorTurno: jugadorTurno, indiceMano: indiceMano });
		  };

		// Acción al pulsar "Mus"
		window.accionMus = function () {
			const mesaId = "{{ mesa.nombre }}";

			console.log(`${jugadores[indiceMano]} ha pulsado Mus.`);
			// Emitir evento para procesar la acción en el servidor
			socket.emit('tratar_mus', { mesa_id: mesaId });
		};
 
		 // Escuchar la actualización de turno y contador desde el servidor
		socket.on('actualizar_mus', function (data) {
			musContador = data.musContador; // Actualizar el contador de "Mus" desde el servidor
			indiceMano = data.indiceMano;   // Actualizar el índice del turno desde el servidor
			jugadorActual = data.jugadorActual;
			let anterior = indiceMano;
			if (anterior === 0) { anterior = 4; } else { anterior -= 1; }
			manoJugador = jugadores[indiceMano];
			jugadorAnterior = jugadores[anterior];
			// Calcular el índice de mano relativo en la lista reorganizada
			const manoJugadorIdx = reorganizedJugadores.findIndex(jugador => jugador === jugadorAnterior);	
			mostrarBocadillo2(manoJugadorIdx, "Mus");
			//console.log("ReorganizedJugadores en MUS para {{ usuario }} : ", reorganizedJugadores);
			//console.log(`Turno actualizado: ${data.jugadorActual} (${indiceMano})`);
			//console.log(`Mus Contador: ${musContador}`);
			//console.log(`Mus Contador: ${musContador}, Turno: ${jugadores[indiceMano]}`);
			mostrarBotones(jugadorActual);	

			if (musContador === 4) { 
				actualizarMazo(indiceMano);
				console.log(`${manoJugador} es ahora el mano. Todos se descartan.`);
				iniciarPeriodoDescarte(manoJugador);
				ocultarBotones();
				// Calcular el índice de mano relativo en la lista reorganizada
				const manoJugadorIdx = reorganizedJugadores.findIndex(jugador => jugador === manoJugador);	
				console.log("Jugador mano es: ", manoJugador, " indice reorganiced es: ", manoJugadorIdx);
				resaltarManoDescarte(manoJugadorIdx);
			}
		});
		});
//********************
		function resaltarMano(manoJugadorIdx) {
			const manoJugador = reorganizedJugadores[manoJugadorIdx];
			//alert("ManoJugador: " + manoJugador);
		    reorganizedJugadores.forEach((jugador, index) => {
			const position = posiciones[index];
			const jugadorElement = document.querySelector(`.${position}`);
			let index2 = 0;
			if (index === 0) { index2 = 3; } else { index2 = index - 1; }
			const position2 = posiciones[index2];
			const jugadorElement2 = document.querySelector(`.${position2}`);
			//console.log("resaltarMano jugadorelement: ", jugadorElement);
			if (jugadorElement) {
			  const avatarElement = jugadorElement.querySelector("img");
			  const aliasElement = jugadorElement.querySelector(".alias");
			  alert("ManoJugador desde py: " + manoJugador + " jugador: " + jugador);
			
			  if (jugador === manoJugador) {
				// Resaltar al nuevo "mano"
			//alert("position: " + position + "   position2: " + position2);
			//alert("index: " + index + "  index2: " + index2);
				mostrarBocadillo(jugadorElement, "Soy mano");
				mostrarBocadillo(jugadorElement2, "Reparto");		
				jugadorElement.classList.add("mano");
				aliasElement.style.color = "yellow"; // Resaltar el nombre
				avatarElement.style.border = "4px solid yellow"; // Resaltar el avatar
				avatarElement.style.animation = "none";
				setTimeout(() => {
				  avatarElement.style.animation = ""; // Reactivar animación
				}, 10);
			  } else {
				// Normalizar al resto
				jugadorElement.classList.remove("mano");
				aliasElement.style.color = "";   // Color por defecto
				avatarElement.style.border = ""; // Borde por defecto
			  }
			}
		  });
		}

		function resaltarManoDescarte(manoJugadorIdx) {
			// Obtener el nombre del jugador que es mano desde la lista original reorganizada
			//const manoJugador = reorganizedJugadores[manoJugadorIdx]; 
			const manoJugador = reorganizedJugadores[manoJugadorIdx];
			console.log("ReorganizedJugadores resaltar para ", manoJugador, " es: ", reorganizedJugadores);
			if (!manoJugador) {
				console.error("No se encontró al jugador mano en la lista reorganizada.");
				return;
			}
			console.log("Indice del jugador: ", manoJugadorIdx, " Valor en reorganized: ", manoJugador);
			// Iterar sobre los jugadores reorganizados para resaltar al jugador correcto
			reorganizedJugadores.forEach((jugador, index) => {
				const position = posiciones[index];
				const jugadorElement = document.querySelector(`.${position}`);

				if (jugadorElement) {
					const avatarElement = jugadorElement.querySelector("img");
					const aliasElement = jugadorElement.querySelector(".alias");

					if (jugador === manoJugador) {
						// Resaltar al nuevo "mano"
						console.log("jugador: ", jugador, " Jugador mano en reorganized ", manoJugador);
						jugadorElement.classList.add("mano");
						aliasElement.style.color = "yellow"; // Resaltar el nombre
						avatarElement.style.border = "4px solid yellow"; // Resaltar el avatar
						avatarElement.style.animation = "none";
						setTimeout(() => {
							avatarElement.style.animation = ""; // Reactivar animación
						}, 10);
					} else {
						// Normalizar al resto
						jugadorElement.classList.remove("mano");
						aliasElement.style.color = ""; // Color por defecto
						avatarElement.style.border = ""; // Borde por defecto
					}
				}
			});
		}


		
		function actualizarMazo(reparte) {
			const mesaElement = document.querySelector('.mesa');
			const mazoElement = document.getElementById('mazo');
			//alert("Valor de reparte: " + reparte);
			// Define posiciones relativas para cada jugador
			const posiciones = {
				0: { top: '70%', left: '60%' }, // Mano arriba
				1: { top: '25%', left: '79%' }, // Mano a la derecha
				2: { top: '7%', right: '57%' }, // Mano abajo (en realidad arriba)
				3: { top: '70%', left: '15%' } // Mano a la izquierda
			};
			// Asegúrate de limpiar estilos anteriores
			mazoElement.style.top = posiciones[reparte]?.top || '';
			mazoElement.style.left = posiciones[reparte]?.left || '';
			mazoElement.style.right = posiciones[reparte]?.right || '';
			mazoElement.style.bottom = posiciones[reparte]?.bottom || '';
		}

	</script>
</body>
	<script>
	
		//==================================================
		// LOGICA PARA SELECCIONAR LAS CARTAS DE DESCARTE
		//==================================================
		let periodoDescarte = false; // Inicialmente no estamos en el periodo de descarte
		
		document.addEventListener('DOMContentLoaded', () => {
		    const contenedorCartas = document.querySelector('.cartas'); // Contenedor de cartas

		    if (contenedorCartas) {
			    contenedorCartas.addEventListener('click', event => {
			  // Detectar si se hizo clic en una carta
			       const carta = event.target.closest('.carta');
			       if (carta) {
				   // Solo permitir la interacción si estamos en el periodo de descarte
				        if (periodoDescarte) {
				          carta.classList.toggle('seleccionada');
				        } else {
				        console.log("No se puede seleccionar cartas fuera del periodo de descarte.");
				        }
			        }
			    });
		    } else {
			console.error('El contenedor de cartas no existe.');
		    }
		});

		// Seleccionamos todas las cartas
		document.querySelectorAll('.carta').forEach(carta => {
		  carta.addEventListener('click', () => {
			// Alternamos la clase 'seleccionada' al hacer clic
			carta.classList.toggle('seleccionada');
		  });
		});
		
		//======================================================
		// TRATAMIENTO DESCARTES al pulsar el botón "Descartar"
		//======================================================
		
		document.getElementById('descartar').addEventListener('click', () => {
		    const cartasSeleccionadas = obtenerCartasSeleccionadas(); // Cartas a descartar
		    const cartasOriginales = obtenerCartasOriginales(); // Cartas originales
		    console.log("Cartas descartadas:", cartasSeleccionadas, " cartas originales:", cartasOriginales);

		  // Lógica para enviar al servidor o procesar los descartes
		    //alert(`Cartas descartadas: ${cartasSeleccionadas.join(', ')}`);
			// Aquí se debería preguntar si el jugador tiene el turno de pedir cartas.
			// de hecho, el boton descartar solo se debería mostrar al jugador que le toque.
			
			if (cartasSeleccionadas.length === 0) {
				alert("Debes seleccionar al menos una carta para descartar.");
				return;
			}
		    //=================================================================
			// Comparar las cartas originales con las seleccionadas para encontrar las que se quedan
			const cartasRestantes = cartasOriginales.filter(carta => !cartasSeleccionadas.includes(carta));
		    console.log("Jugador que va a pedir cartas: ", "{{ usuario }}", " Cartas restantes: ", cartasRestantes);
			
			//alert("Va a hacer el emit de pedir_cartas");
			socket.emit('pedir_cartas', {
				mesa_id: "{{ mesa.nombre }}", 
				jugador: "{{ usuario }}", 
				num_cartas: cartasSeleccionadas.length,
				cartasRestantes
			})
			// Limpia las selecciones
			//document.querySelectorAll('.carta.seleccionada').forEach(carta => carta.classList.remove('seleccionada'));
			// Elimina las cartas seleccionadas visualmente
			cartasSeleccionadas.forEach(carta => {
				const cartaElement = document.getElementById(carta);
				if (cartaElement) cartaElement.remove();
			});
			
		  // Tenemos que recuperar las cartas que cada jugador se ha quedado y las que se descarta o si no que
		  // lógica las gestione el servidor y reparta cuatro nuevas cartas con las que se quedo y las nuevas.
		  // Hay que realizar un emit desde aquí cada cliente y el servidor repartir por turno.n
			
			
		  //alert("Se oculta el botón de Descartar, se vuelven a activar Corto y Mus solo al jugador turno");
		  // Finalizar el periodo de descarte
		    periodoDescarte = false;
			ocultarBotonDescartar();
			ocultarBotones();

		  // Opcional: Desactivar las cartas después del descarte
		    document.querySelectorAll('.carta.seleccionada').forEach(carta => {
			  carta.classList.remove('seleccionada');


			// Marcar cartas como seleccionadas al hacer clic
			document.querySelectorAll('.carta').forEach(carta => {
				carta.addEventListener('click', function () {
					this.classList.toggle('seleccionada');
				});
			});

		});
		});

		socket.on('descartes_actualizados', (data) => {
			console.log("Descartes actualizados:", data);
        // este es el emit de py emit('descartes_actualizados', {'mesa_id': mesa_id, 'descartes': mesa['descartes']}, room=mesa_id)

			// Opcional: Actualizar el estado de descartes en la interfaz si es necesario
		});

		// Escuchar la respuesta del servidor para recibir nuevas cartas
		socket.on('cartas_pedidas', function (data) {
			const { jugador, turno_actual, contDescartados, nuevas_cartas } = data;
			console.log("cartas_pedidas data:", data);
			// Actualiza las cartas del jugador en la interfaz
			//alert("usuario cliente: " + "{{ usuario }}" + " usuario py: " + jugador);
			if (jugador === "{{ usuario }}") {
				const cartasContainer = document.querySelector('.cartas');
				cartasContainer.innerHTML = ''; // Limpia las cartas actuales
				nuevas_cartas.forEach(carta => {
					const cartaElement = document.createElement('div');
					cartaElement.classList.add('carta');
					cartaElement.style.backgroundImage = `url('../static/img/cartas/${carta}.png')`;
					cartasContainer.appendChild(cartaElement);
				});
			}
			console.log("Cartas pedidas, jugador siguiente:", turno_actual);
			iniciarPeriodoDescarte(turno_actual);
			console.log("Contador de descartados === ", contDescartados);
			if (contDescartados === 4) {
				periodoDescarte = false;
				ocultarBotonDescartar();
				mostrarBotones(turno_actual);
			}
		});
			
		function obtenerCartasSeleccionadas() {
		  const seleccionadas = [];
		  document.querySelectorAll('.carta.seleccionada').forEach(carta => {
			// Extraemos la URL del fondo
			const backgroundImage = carta.style.backgroundImage;

			// Extraemos solo el nombre del archivo
			const nombreCarta = backgroundImage
			  .replace(/url\(["']?/, '') // Elimina 'url("'
			  .replace(/["']?\)/, '') // Elimina '")'
			  .split('/').pop() // Obtiene solo el último segmento (el nombre del archivo)
			  .replace('.png', ''); // Elimina la extensión .png

			seleccionadas.push(nombreCarta); // Añade solo el nombre de la carta
		  });
		  return seleccionadas;
		}
		
		function obtenerCartasOriginales() {
		  const originales = [];
			document.querySelectorAll('.jugador-1 .cartas .carta').forEach(carta => {
			// Extraemos la URL del fondo
			const backgroundImage = carta.style.backgroundImage;
			// Extraemos solo el nombre del archivo
			const nombreCarta = backgroundImage
			  .replace(/url\(["']?/, '') // Elimina 'url("'
			  .replace(/["']?\)/, '') // Elimina '")'
			  .split('/').pop() // Obtiene solo el último segmento (el nombre del archivo)
			  .replace('.png', ''); // Elimina la extensión .png

			originales.push(nombreCarta); // Añade solo el nombre de la carta
		  });
		  return originales;
		}

		// Iniciar el periodo de descarte
		function iniciarPeriodoDescarte(jugadorDescarte) {
		  periodoDescarte = true;
		  mostrarBotonDescartar(jugadorDescarte);
		  console.log("Periodo de descarte activado");
		}
	
		// Mostrar el botón "Descartar"
		function mostrarBotonDescartar(jugadorDescarte) {
			const username = "{{ usuario }}";
			console.log("MostrarBotonDescartar. Usuario siguiente: ", jugadorDescarte);
			const botonDescartar = document.getElementById('descartar');
			//botonDescartar.textContent = `Turno descarte: ${jugadorDescarte}`;
			ocultarBotones();
			botonDescartar.innerHTML = `Turno de descarte:<br><strong>${jugadorDescarte}</strong>`;
			botonDescartar.style.display = 'inline-block'; // Cambia el estilo a visible
		    console.log("Botón Descartar: ", `Turno descarte: ${jugadorDescarte}`);
			// Activar el botón solo para el usuario correspondiente
			if (username === jugadorDescarte) {
				botonDescartar.classList.add('activo'); // Habilitar el botón
			} else {
				botonDescartar.classList.remove('activo'); // Deshabilitar el botón
			}
		}

		// Ocultar el botón "Descartar"
		function ocultarBotonDescartar() {
			const botonDescartar = document.getElementById('descartar');
			botonDescartar.style.display = 'none'; // Oculta el botón
		}

		
		//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
		//	Función para ocultar los botones de MUS y Corto después de repartir		
		//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
		
	    function ocultarBotones() {
			//const turnoLabel = document.getElementById("turnoJugador");
			//turnoLabel.classList.add("oculto");
			console.log("Va a OCULTAR los botones de Corto y Mus.");
			const botonesJuego = document.getElementById('botones-juego');
			botonesJuego.style.display = 'none'; // Ocultar los botones de MUS y Corto
	    }
				
		function mostrarMesaBotones(jugador, indiceMano) {		
			const mesaBotones = document.querySelector('.mesa-botones');
			mesaBotones.style.display = 'flex';
			mesaBotones.classList.add('fade-in');
			const botines = document.querySelectorAll('.botines');
			botines.forEach(botin => {
				botin.classList.remove('bloqueado'); // Desbloquea
			});	
		}
				
		function bloquearMesaBotones(jugador, indiceMano) {
			const mesaBotones = document.querySelector('.mesa-botones');
			mesaBotones.style.display = 'flex';
			mesaBotones.classList.add('fade-in');
			const botines = document.querySelectorAll('.botines');
			botines.forEach(botin => {
				botin.classList.add('bloqueado'); // Bloquea
			});			
		}
		function ocultarMesaBotones() {
		    const mesaBotones = document.querySelector('.mesa-botones');
		    mesaBotones.style.display = 'none';
		}

	// CODIGO PARA LA GESTION DE LOS TURNOS Y ACTIVACIÓN Y DESACTIVACION DE BOTONES
	
    // Recibir actualizaciones para comenzar la ronda desde el servidor
    socket.on('comenzar_ronda', (data) => {
		indiceMano = data.turno_actual;
		jugadorTurno = data.jugador_turno;	
		mostrarTurno(jugadorTurno);
		console.log('jugadorTurno desde servidor:', jugadorTurno, " jugador cliente: ", "{{ usuario }}");
		ocultarBotones();
		const manoJugadorIdx = reorganizedJugadores.findIndex(jugador => jugador === jugadorTurno);	
		console.log("Comenzar ronda. Jugador mano es: ", jugadorTurno, " indice reorganiced es: ", manoJugadorIdx);
		resaltarManoDescarte(manoJugadorIdx);
		mostrarBocadillo2(manoJugadorIdx, "Corto");	
		const textoLance = document.getElementById('texto-lance');
		textoLance.textContent = "Grande";
					 
		const esMiTurno = jugadorTurno === "{{ usuario }}";
		if (esMiTurno) {
			//alert("Es tu turno. Puedes jugar.");
			mostrarMesaBotones();
			console.log("Es tu turno. Puedes jugar.");
		} else {
			// Desactivar/bloquear los botones del centro 
			bloquearMesaBotones();
			//alert("Espera tu turno.");
		}
    });	

		//==================================================
		// TRATAMIENTO DE LOS BOTONES DE CADA LANCE
		//==================================================
		// Valor inicial del envido
		let valorEnvido = 2;

		// Referencias a los elementos
		const spanEnvido = document.getElementById('valor-envido');
		const botonIncrementar = document.getElementById('incrementar-envido');
		const botonDecrementar = document.getElementById('decrementar-envido');
		const botonEnvidar = document.getElementById('envidar');
		const jugadores = mesa.jugadores;
		const jugador = mesa.jugadores[mesa.mano]   //"{{ usuario  }}";
		
		// Incrementar el valor del envido
		botonIncrementar.addEventListener('click', () => {
		  valorEnvido++;
		  spanEnvido.textContent = valorEnvido;
		});

		// Decrementar el valor del envido
		botonDecrementar.addEventListener('click', () => {
		  if (valorEnvido > 2) {
			valorEnvido--;
			spanEnvido.textContent = valorEnvido;
		  }
		});

		// Acción al hacer clic en el botón de "Envidar"
		botonEnvidar.addEventListener('click', () => {	
			const mesaId = "{{ mesa.nombre }}";		
			const jugadorC = "{{ usuario }}";
			console.log(`${jugadorC} envida ${valorEnvido}`);
			enviarAccion(jugadorC, "Envido", valorEnvido);
			

			const mensaje = `${jugador} envida ${valorEnvido}`;
			socket.emit('mensaje_chat_mesa', { mesa_id: mesaId, username: 'Docemas', message: mensaje });
		});

		// Botón de Órdago
		document.getElementById('ordago').addEventListener('click', () => {
			//alert('¡Órdago lanzado!');
			const jugadorC = "{{ usuario }}";
			console.log(`${jugadorC} lanza un órdago.`);
			const mensaje = `${jugadorC} lanza un órdago.`;
			socket.emit('mensaje_chat_mesa', { mesa_id: mesaId, username: 'Docemas', message: mensaje });
			enviarAccion(jugadorC, "Órdago");
		});

		// Botón de Ver
		document.getElementById('ver').addEventListener('click', () => {
		    //alert('Has visto el envido.');
			const jugadorC = "{{ usuario }}";
			console.log(`${jugadorC} ve el envite.`);
			const mensaje = `${jugadorC} ve el envite.`;
			socket.emit('mensaje_chat_mesa', { mesa_id: mesaId, username: 'Docemas', message: mensaje });
			enviarAccion(jugadorC, "Veo");
		});

		// Botón de Paso
		document.getElementById('paso').addEventListener('click', () => {
			//alert('Has pasado.');
			const jugadorC = "{{ usuario }}";
			console.log(`${jugadorC} ha pasado.`);
			const mensaje = `${jugadorC} ha pasado.`;
			socket.emit('mensaje_chat_mesa', { mesa_id: mesaId, username: 'Docemas', message: mensaje });
			enviarAccion(jugadorC, "Paso");
		});

		function enviarAccion(jugadorC, accion, valorEnvido = 0) {
			const mensaje = {
				mesa_id: mesaId,
				jugador: jugadorC,
				accion: accion,
				envido: valorEnvido  // Valor del envido si aplica
			};
			socket.emit('accion_jugador', mensaje);
		}
			
	//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	// RECIBE CADA ITERACION DEL JUEGO Y ACTUALIZA LA INTERFAZ DEL CLIENTE %
	//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	
	socket.on('estado_actualizado', (mesa) => {
		console.log("Estado actualizado Mesa:", mesa);
		const jugadorActual = "{{ usuario }}";
		const jugadorAnterior = mesa.jugadorAnterior;
		const turnoActual = mesa.turno_actual;
		console.log("Estado actualizado turno actual:", turnoActual, " jugAnterior: ", jugadorAnterior);
		const turnoJugador = mesa.jugadores[turnoActual];
		const lanceActual = mesa.lance_actual;
		const accion = mesa.accion;
		const apuesta = mesa.apuesta; 
		let hablar = accion; 
		
		// El jugador anterior habla su lance		
		if (apuesta === 0) { hablar = accion; } else { hablar = accion + " " + apuesta; }
		const manoJugadorIdx = reorganizedJugadores.findIndex(jugador => jugador === jugadorAnterior);	
		
		console.log("Valor de hablar: ", hablar,  " accion: ", accion, " apuesta: ", apuesta);
		console.log('Estado actualizado. manoJugadorIdx: ', manoJugadorIdx, " reorganizedJugadores: ", reorganizedJugadores);
		mostrarBocadillo2(manoJugadorIdx, hablar);		
		// Actualizar marcador
		document.getElementById('puntos-pareja1').textContent = mesa.puntos[0];
		document.getElementById('puntos-pareja2').textContent = mesa.puntos[1];

		// Actualizar los juegos 
		document.getElementById('juegos-pareja1').textContent = mesa.juegos[0];
		document.getElementById('juegos-pareja2').textContent = mesa.juegos[1];

		// Actualizar turno
		mostrarTurno(turnoJugador);
		console.log('Estado actualizado. es el turno de: ', turnoJugador, " jugador cliente: ", jugadorActual, " juagodor anterior: ", jugadorAnterior);

		// Actualizar lanceturno
		const textoLance = document.getElementById('texto-lance');
		textoLance.textContent = lanceActual;

		// Mostrar/ocultar botones según el turno
		if (turnoJugador === jugadorActual) {
			mostrarMesaBotones(jugadorActual, turnoActual);
		} else {
			bloquearMesaBotones();
		}
	});


	socket.on("pares_confirmados", (data) => {
		const resultados = data.resultados_pares;
		const total_pares = data.total_pares;
		const turno_actual = data.turno_actual;
		const contrarias = data.contrarias;
		console.log("Resultados de pares recibidos:", resultados, " total_pares: ", total_pares, " turno_actual: ", turno_actual, " parejas contrarias: ", contrarias);
		const jugadorActual = "{{ usuario }}";
		const turnoJugador = jugadores[turno_actual];
		// Actualizar lanceturno
		const textoLance = document.getElementById('texto-lance');
		textoLance.textContent = "Pares";
		
		// Mostrar la información de quienes tienen pares o no en la interfaz
		Object.entries(resultados).forEach(([jugadorP, tienePares]) => {
			const manoJugadorIdx = reorganizedJugadores.findIndex(jugador => jugador === jugadorP);
			// Determinar el mensaje y mostrar el bocadillo
			let mensaje;
			if (tienePares) {
				setTimeout(() => {
					mensaje = `${jugadorP} tiene pares.`;
					mostrarBocadillo2(manoJugadorIdx, "Tengo pares");
				}, 3000);
			} else {
				setTimeout(() => {
					mensaje = `${jugadorP} no tiene pares.`;
					mostrarBocadillo2(manoJugadorIdx, "No tengo pares");
				}, 3000);
			}
			console.log(mensaje); // Muestra el mensaje en la consola
		});

		// En el caso de que al menos haya dos jugadores contrarios con pares, comienza el lance
		if ((total_pares > 2) || (total_pares === 2 && contrarias)) {
			console.log("Hay partida de pares ");
			mostrarTurno(turnoJugador);
			if (turnoJugador === jugadorActual) {
				mostrarMesaBotones(turnoJugador, turno_actual);
			} else {
				bloquearMesaBotones();
			}
		}
	});

	socket.on("juego_confirmado", (resultados) => {
		console.log("Resultados de juego recibidos:", resultados);
		//console.log("ReorganizedJugadores:", reorganizedJugadores);
		// Actualizar el texto del lance en la interfaz
		const textoLance = document.getElementById('texto-lance');
		textoLance.textContent = "Juego";

		// Mostrar la información en la interfaz
		Object.entries(resultados).forEach(([jugadorJg, infoJuego]) => {
			const manoJugadorIdx = reorganizedJugadores.findIndex(jugador => jugador === infoJuego.jugador);
			//console.log("juego_confirmado. Jugador: ", infoJuego.jugador, " manoJugadorIdx: ", manoJugadorIdx);
			// Determinar el mensaje y mostrar el bocadillo
			let mensaje;
			if (infoJuego.tiene_juego) {
				setTimeout(() => {
					mensaje = `${infoJuego.jugador} tiene juego.`;
					mostrarBocadillo2(manoJugadorIdx, "Tengo juego");
				}, 5000);
			} else {
				setTimeout(() => {
					mensaje = `${infoJuego.jugador} no tiene juego.`;
					mostrarBocadillo2(manoJugadorIdx, "No tengo juego");
				}, 5000);
			}
			console.log(mensaje); // Muestra el mensaje en la consola
		});
	});


	socket.on("actualizar_interfaz_ronda", (data) => {
		const jugadorCliente = "{{ usuario }}";
		const turnoActual = mesa.turno_actual;
		const jugadorActual = jugadores[turnoActual];

		console.log("Actualización de ronda recibida:", data);

		console.log('Estado actualizado. manoJugadorIdx: ', manoJugadorIdx, " reorganizedJugadores: ", reorganizedJugadores);

		// Actualizar marcador
		document.getElementById('puntos-pareja1').textContent = mesa.puntos[0];
		document.getElementById('puntos-pareja2').textContent = mesa.puntos[1];

		// Actualizar los juegos 
		document.getElementById('juegos-pareja1').textContent = mesa.juegos[0];
		document.getElementById('juegos-pareja2').textContent = mesa.juegos[1];

		// Actualizar turno
		mostrarTurno(turnoJugador);
		console.log('Estado actualizado. es el turno de: ', turnoJugador, " jugador cliente: ", jugadorActual, " juagodor anterior: ", jugadorAnterior);

		// Actualizar lanceturno
		const textoLance = document.getElementById('texto-lance');
		textoLance.textContent = lanceActual;
		
		// Habla el jugador mano nueva ronda
		const manoJugadorIdx = reorganizedJugadores.findIndex(jugador => jugador === jugadorActual);	
		mostrarBocadillo2(manoJugadorIdx, "Empezamos la ronda. Soy mano.);		
		
		// Mostrar/ocultar el botón de repartir y ocultar los botones de mesa
		if (jugadorCliente === jugadorActual) {
			const btnRepartir = document.getElementById("btn-repartir");
			ocultarMesaBotones();
			btnRepartir.classList.remove("oculto");
		} else {
			const btnRepartir = document.getElementById("btn-repartir");
			btnRepartir.classList.add("oculto");
			ocultarMesaBotones();
		}
	});


	socket.on("juego_finalizado", (data) => {
		console.log("Juego finalizado:", data);

		// Mostrar mensaje de fin de juego
		mostrarMensaje(data.mensaje);

		// Actualizar puntos finales
		actualizarPuntos(data.puntos_finales);

		// Mostrar los juegos finales acumulados
		actualizarJuegos(data.juegos_finales);

		// Bloquear interacciones adicionales en la interfaz
		bloquearInterfaz();
	});



    // Recibir actualizaciones para el evento de envidar
    socket.on('recibir_envite', (data) => {
		indiceMano = data.turno_actual;
		jugadorTurno = data.jugador_turno;	
		jugadorSiguiente = data.jugadorSiguiente;
		valorEnvido = data.valorEnvido;
		
		mostrarTurno(jugadorTurno);
		console.log('jugadorTurno desde servidor:', jugadorTurno, " jugador cliente: ", "{{ usuario }}");
		ocultarBotones();

		const manoJugadorIdx = reorganizedJugadores.findIndex(jugador => jugador === jugadorTurno);	
		console.log(jugadorTurno, " envida a grande ", valorEnvido);
		mostrarBocadillo2(manoJugadorIdx, "Envido "+ valorEnvido);	
		const mensaje = jugadorTurno + " envida " + valorEnvido + " habla " + jugadorSiguiente;
		socket.emit('mensaje_chat_mesa', { mesa_id: mesaId, username: 'Docemas', message: mensaje });					 
		socket.emit("accion", { 
			jugador_id: jugadorId, 
			accion: accion, 
			apuesta: apuesta 
		});
		const esMiTurno = jugadorSiguiente === "{{ usuario }}";
		if (esMiTurno) {
			mostrarMesaBotones();
			console.log("Es tu turno. Puedes jugar.");
		} else {
			bloquearMesaBotones();
		}
    });	

	
	</script>
</html>